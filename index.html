<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å›¾ä¹¦å€Ÿè¿˜ç³»ç»Ÿï¼ˆGoogle Sheetsç‰ˆï¼‰</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      max-width: 800px; 
      margin: 30px auto; 
      padding: 20px; 
      background-color: #f5f7fa;
    }
    h1 { 
      text-align: center; 
      color: #2c3e50; 
      margin-bottom: 30px;
    }
    .input-group { 
      margin-bottom: 20px; 
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    input, button { 
      font-size: 1.1em; 
      padding: 12px; 
      width: 100%; 
      box-sizing: border-box; 
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button { 
      background: #3498db; 
      color: white; 
      border: none; 
      cursor: pointer;
      transition: background 0.3s;
      font-weight: bold;
    }
    button:hover { background: #2980b9; }
    button:disabled {
      background: #95a5a6;
      cursor: not-allowed;
    }
    #bookDetails { 
      background: white; 
      padding: 20px; 
      margin-top: 20px; 
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #log { 
      margin-top: 20px; 
      padding: 15px; 
      border-radius: 8px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .hidden { display: none; }
    .loading {
      text-align: center;
      color: #7f8c8d;
      font-style: italic;
    }
    .success {
      color: #27ae60;
      background: #e8f8f5;
      padding: 10px;
      border-radius: 4px;
    }
    .error {
      color: #e74c3c;
      background: #fdedec;
      padding: 10px;
      border-radius: 4px;
    }
    .book-info {
      margin-bottom: 15px;
    }
    .book-info p {
      margin: 5px 0;
      color: #34495e;
    }
    .book-title {
      font-size: 1.3em;
      font-weight: bold;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .action-buttons button {
      flex: 1;
    }
    .return-btn {
      background: #e74c3c;
    }
    .return-btn:hover {
      background: #c0392b;
    }
    .borrow-btn {
      background: #2ecc71;
    }
    .borrow-btn:hover {
      background: #27ae60;
    }
  </style>
</head>
<body>
  <h1>ğŸ“š å›¾ä¹¦å€Ÿè¿˜ç³»ç»Ÿï¼ˆäº‘ç«¯ç‰ˆï¼‰</h1>

  <div class="input-group">
    <input type="text" id="bookName" placeholder="è¾“å…¥ä¹¦åã€ä½œè€…æˆ–å‡ºç‰ˆç¤¾" autocomplete="off">
    <button id="searchBtn" onclick="searchBook()">æŸ¥è¯¢å›¾ä¹¦</button>
    <div id="loadingIndicator" class="hidden loading">æ­£åœ¨åŠ è½½æ•°æ®...</div>
  </div>

  <div id="bookDetails" class="hidden">
    <div class="book-info">
      <div class="book-title" id="detailTitle"></div>
      <p id="detailAuthor"></p>
      <p id="detailPublisher"></p>
      <p id="detailStock"></p>
      <p id="detailStatus"></p>
    </div>
    <div id="borrowSection" class="hidden">
      <input type="text" id="borrower" placeholder="å€Ÿé˜…äººå§“å" autocomplete="off">
      <input type="text" id="idNumber" placeholder="è¯ä»¶å·" autocomplete="off">
      <div class="action-buttons">
        <button class="borrow-btn" onclick="borrowBook()">å€Ÿä¹¦</button>
        <button class="return-btn" onclick="returnBook()">è¿˜ä¹¦</button>
      </div>
    </div>
  </div>

  <div id="log"></div>

  <script>
    // é…ç½®éƒ¨åˆ† - è¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹
    const scriptURL = 'https://script.google.com/macros/s/AKfycbx9EDZICzWSABa4O_iE6BguYj_-7yBPI2G7gagRHcbOHbXau9t5QIlGFWOj6LptiBbk/exec';
    let books = [];
    let selectedBook = null;
    let isLoading = false;

    // é¡µé¢åŠ è½½æ—¶è·å–æ‰€æœ‰å›¾ä¹¦æ•°æ®
    window.onload = function() {
      loadBooks();
    };

    // åŠ è½½å›¾ä¹¦æ•°æ®
    function loadBooks() {
      isLoading = true;
      toggleLoading(true);
      showLog('æ­£åœ¨ä»äº‘ç«¯åŠ è½½å›¾ä¹¦æ•°æ®...', 'info');
      
      fetch(scriptURL)
        .then(response => {
          if (!response.ok) {
            throw new Error('ç½‘ç»œå“åº”ä¸æ­£å¸¸');
          }
          return response.json();
        })
        .then(data => {
          if (!Array.isArray(data)) {
            throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
          }
          
          books = data;
          console.log("äº‘ç«¯æ•°æ®åŠ è½½æˆåŠŸ", books);
          showLog('å›¾ä¹¦æ•°æ®åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹æŸ¥è¯¢', 'success');
        })
        .catch(error => {
          console.error("åŠ è½½å¤±è´¥:", error);
          showLog(`æ— æ³•åŠ è½½å›¾ä¹¦æ•°æ®: ${error.message}`, 'error');
          showLog('è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç³»ç»Ÿç®¡ç†å‘˜', 'error');
        })
        .finally(() => {
          isLoading = false;
          toggleLoading(false);
        });
    }

    function searchBook() {
      if (isLoading) {
        showLog('æ•°æ®æ­£åœ¨åŠ è½½ä¸­ï¼Œè¯·ç¨åå†è¯•', 'warning');
        return;
      }

      const keyword = document.getElementById('bookName').value.trim();
      const detailsDiv = document.getElementById('bookDetails');
      detailsDiv.classList.add('hidden');

      if (!keyword) {
        showLog('è¯·è¾“å…¥æœç´¢å…³é”®è¯', 'warning');
        return;
      }

      // æœç´¢ä¹¦åã€ä½œè€…æˆ–å‡ºç‰ˆç¤¾ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
      const lowerKeyword = keyword.toLowerCase();
      selectedBook = books.find(book => 
        (book.ä¹¦å && book.ä¹¦å.toLowerCase().includes(lowerKeyword)) || 
        (book.ä½œè€… && book.ä½œè€….toLowerCase().includes(lowerKeyword)) || 
        (book.å‡ºç‰ˆç¤¾ && book.å‡ºç‰ˆç¤¾.toLowerCase().includes(lowerKeyword))
      );

      if (selectedBook) {
        // æ˜¾ç¤ºå›¾ä¹¦è¯¦æƒ…
        document.getElementById('detailTitle').innerText = selectedBook.ä¹¦å || 'æœªçŸ¥ä¹¦å';
        document.getElementById('detailAuthor').innerText = `ä½œè€…: ${selectedBook.ä½œè€… || 'æœªçŸ¥'}`;
        document.getElementById('detailPublisher').innerText = `å‡ºç‰ˆç¤¾: ${selectedBook.å‡ºç‰ˆç¤¾ || 'æœªçŸ¥'}`;
        document.getElementById('detailStock').innerText = `åº“å­˜: ${selectedBook.åº“å­˜ || 0}æœ¬`;
        document.getElementById('detailStatus').innerText = `çŠ¶æ€: ${selectedBook.çŠ¶æ€ || 'æœªçŸ¥'}`;
        
        // æ ¹æ®çŠ¶æ€æ˜¾ç¤º/éšè—å€Ÿè¿˜æŒ‰é’®
        const borrowSection = document.getElementById('borrowSection');
        const isAvailable = selectedBook.çŠ¶æ€ === 'å¯å€Ÿ';
        borrowSection.classList.toggle('hidden', !isAvailable);
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        document.getElementById('borrower').value = '';
        document.getElementById('idNumber').value = '';
        
        detailsDiv.classList.remove('hidden');
        showLog(`æ‰¾åˆ°å›¾ä¹¦: ${selectedBook.ä¹¦å}`, 'success');
      } else {
        showLog(`æœªæ‰¾åˆ°åŒ¹é…"${keyword}"çš„å›¾ä¹¦`, 'warning');
      }
    }

    function borrowBook() {
      handleBorrowReturn('borrow');
    }

    function returnBook() {
      handleBorrowReturn('return');
    }

    function handleBorrowReturn(action) {
      const borrower = document.getElementById('borrower').value.trim();
      const idNumber = document.getElementById('idNumber').value.trim();

      if (!borrower || !idNumber) {
        showLog('è¯·å¡«å†™å®Œæ•´å€Ÿé˜…äººä¿¡æ¯', 'warning');
        return;
      }

      if (!selectedBook) {
        showLog('æœªé€‰æ‹©å›¾ä¹¦ï¼Œè¯·å…ˆæŸ¥è¯¢å›¾ä¹¦', 'error');
        return;
      }

      // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤æäº¤
      const buttons = document.querySelectorAll('#borrowSection button');
      buttons.forEach(btn => btn.disabled = true);
      
      showLog(`${action === 'borrow' ? 'å€Ÿä¹¦' : 'è¿˜ä¹¦'}å¤„ç†ä¸­...`, 'info');

      fetch(scriptURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: action,
          bookName: selectedBook.ä¹¦å,
          borrower: borrower,
          idNumber: idNumber,
          timestamp: new Date().toISOString()
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error('æœåŠ¡å™¨å“åº”é”™è¯¯');
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          showLog(`${action === 'borrow' ? 'å€Ÿä¹¦' : 'è¿˜ä¹¦'}æˆåŠŸ: ${selectedBook.ä¹¦å}`, 'success');
          // åˆ·æ–°æ•°æ®
          setTimeout(() => {
            loadBooks();
            document.getElementById('bookDetails').classList.add('hidden');
          }, 1500);
        } else {
          throw new Error(data.message || 'æ“ä½œå¤±è´¥');
        }
      })
      .catch(error => {
        console.error("æ“ä½œå¤±è´¥:", error);
        showLog(`${action === 'borrow' ? 'å€Ÿä¹¦' : 'è¿˜ä¹¦'}å¤±è´¥: ${error.message}`, 'error');
      })
      .finally(() => {
        buttons.forEach(btn => btn.disabled = false);
      });
    }

    function showLog(message, type = 'info') {
      const logDiv = document.getElementById('log');
      let className = '';
      
      switch(type) {
        case 'success':
          className = 'success';
          break;
        case 'error':
          className = 'error';
          break;
        case 'warning':
          className = 'warning';
          break;
        default:
          className = 'info';
      }
      
      logDiv.innerHTML = `<div class="${className}">${message}</div>`;
    }

    function toggleLoading(show) {
      const loadingIndicator = document.getElementById('loadingIndicator');
      const searchBtn = document.getElementById('searchBtn');
      
      if (show) {
        loadingIndicator.classList.remove('hidden');
        searchBtn.disabled = true;
      } else {
        loadingIndicator.classList.add('hidden');
        searchBtn.disabled = false;
      }
    }

    // æ·»åŠ å›è½¦é”®æœç´¢åŠŸèƒ½
    document.getElementById('bookName').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        searchBook();
      }
    });
  </script>
</body>
</html>
