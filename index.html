<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å›¾ä¹¦å€Ÿè¿˜ç³»ç»Ÿï¼ˆGoogle Sheetsç‰ˆï¼‰</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 30px auto; padding: 20px; }
    h1 { text-align: center; color: #2c3e50; }
    .input-group { margin-bottom: 15px; }
    input, button { 
      font-size: 1.1em; 
      padding: 10px; 
      width: 100%; 
      box-sizing: border-box; 
    }
    button { 
      background: #3498db; 
      color: white; 
      border: none; 
      cursor: pointer;
      margin-top: 5px;
    }
    button:hover { background: #2980b9; }
    #bookDetails { 
      background: #f8f9fa; 
      padding: 15px; 
      margin-top: 20px; 
      border-radius: 5px; 
    }
    #log { 
      margin-top: 20px; 
      padding: 10px; 
      border-top: 1px solid #eee; 
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1>ğŸ“š å›¾ä¹¦å€Ÿè¿˜ç³»ç»Ÿï¼ˆäº‘ç«¯ç‰ˆï¼‰</h1>

  <div class="input-group">
    <input type="text" id="bookName" placeholder="è¾“å…¥ä¹¦åã€ä½œè€…æˆ–å‡ºç‰ˆç¤¾">
    <button onclick="searchBook()">æŸ¥è¯¢å›¾ä¹¦</button>
  </div>

  <div id="bookDetails" class="hidden">
    <h3 id="detailTitle"></h3>
    <p id="detailAuthor"></p>
    <p id="detailStock"></p>
    <div id="borrowSection" class="hidden">
      <input type="text" id="borrower" placeholder="å€Ÿé˜…äººå§“å">
      <input type="text" id="idNumber" placeholder="è¯ä»¶å·">
      <button onclick="borrowBook()">å€Ÿä¹¦</button>
      <button onclick="returnBook()">è¿˜ä¹¦</button>
    </div>
  </div>

  <div id="log"></div>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbz5pZAVmQ-mO87hoXa1IkAEiCn7qZ2YJmdv7yIME0dyjAjkvc4yXVGha2mTF9sxeZj-/exec'; // æ›¿æ¢ä¸ºä½ çš„Google Apps Scriptéƒ¨ç½²URL
    let books = [];
    let selectedBook = null;

    // é¡µé¢åŠ è½½æ—¶è·å–æ‰€æœ‰å›¾ä¹¦æ•°æ®
    window.onload = function() {
      fetch(scriptURL)
        .then(response => response.json())
        .then(data => {
          books = data;
          console.log("äº‘ç«¯æ•°æ®åŠ è½½æˆåŠŸ", books);
        })
        .catch(error => {
          console.error("åŠ è½½å¤±è´¥", error);
          alert("æ— æ³•åŠ è½½å›¾ä¹¦æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è¡¨æ ¼é…ç½®");
        });
    };

    function searchBook() {
      const keyword = document.getElementById('bookName').value.trim();
      const detailsDiv = document.getElementById('bookDetails');
      detailsDiv.classList.add('hidden');

      if (!keyword) {
        showLog('â— è¯·è¾“å…¥æœç´¢å…³é”®è¯');
        return;
      }

      // æœç´¢ä¹¦åã€ä½œè€…æˆ–å‡ºç‰ˆç¤¾
      selectedBook = books.find(book => 
        book.ä¹¦å.includes(keyword) || 
        book.ä½œè€…?.includes(keyword) || 
        book.å‡ºç‰ˆç¤¾?.includes(keyword)
      );

      if (selectedBook) {
        document.getElementById('detailTitle').innerText = selectedBook.ä¹¦å;
        document.getElementById('detailAuthor').innerText = 
          `ä½œè€…ï¼š${selectedBook.ä½œè€… || 'æœªçŸ¥'} | å‡ºç‰ˆç¤¾ï¼š${selectedBook.å‡ºç‰ˆç¤¾ || 'æœªçŸ¥'}`;
        document.getElementById('detailStock').innerText = 
          `åº“å­˜ï¼š${selectedBook.åº“å­˜}æœ¬ | çŠ¶æ€ï¼š${selectedBook.çŠ¶æ€}`;
        
        const borrowSection = document.getElementById('borrowSection');
        borrowSection.classList.toggle('hidden', selectedBook.çŠ¶æ€ !== 'å¯å€Ÿ');
        detailsDiv.classList.remove('hidden');
      } else {
        showLog('âŒ æœªæ‰¾åˆ°åŒ¹é…çš„å›¾ä¹¦');
      }
    }

    function borrowBook() {
      handleBorrowReturn('borrow');
    }

    function returnBook() {
      handleBorrowReturn('return');
    }

    function handleBorrowReturn(action) {
      const borrower = document.getElementById('borrower').value.trim();
      const idNumber = document.getElementById('idNumber').value.trim();

      if (!borrower || !idNumber) {
        showLog('â— è¯·å¡«å†™å®Œæ•´å€Ÿé˜…äººä¿¡æ¯');
        return;
      }

      fetch(scriptURL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: action,
          bookName: selectedBook.ä¹¦å,
          borrower: borrower,
          idNumber: idNumber
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showLog(`âœ… ${action === 'borrow' ? 'å€Ÿä¹¦' : 'è¿˜ä¹¦'}æˆåŠŸï¼š${selectedBook.ä¹¦å}`);
          // åˆ·æ–°æ•°æ®
          window.location.reload();
        }
      })
      .catch(error => {
        console.error("æ“ä½œå¤±è´¥", error);
        showLog('âŒ æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
      });
    }

    function showLog(message) {
      document.getElementById('log').innerHTML = message;
    }
  </script>
</body>
</html>